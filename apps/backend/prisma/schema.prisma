// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Audit Log - Complete history of all authorization activities
model AuditLog {
  id         String   @id
  timestamp  BigInt
  eventType  String
  actor      String
  target     String?
  startTime  BigInt?
  endTime    BigInt?
  success    Boolean
  details    Json?
  createdAt  DateTime @default(now())

  @@index([timestamp])
  @@index([eventType])
  @@index([actor])
  @@index([createdAt])
  @@map("audit_logs")
}

// Access Control Policies
model Policy {
  id          String   @id @default(cuid())
  name        String
  type        String
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  config      Json?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([priority])
  @@index([enabled])
  @@index([type])
  @@map("policies")
}

// Master Keypair Storage (encrypted at rest)
model MasterKey {
  id              String    @id @default(cuid())
  algorithm       String
  curve           String
  publicKeyJwk    Json
  privateKeyJwk   Json      // Encrypted with MASTER_KEY_ENCRYPTION_KEY
  createdAt       DateTime  @default(now())
  rotatedAt       DateTime?
  active          Boolean   @default(true)

  @@index([active])
  @@map("master_keys")
}

// Admin User Management - WHO can manage the KMS via web interface
model Admin {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  email        String?
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([username])
  @@index([enabled])
  @@map("admins")
}

// Requester Management - WHO can request access
model Requester {
  id          String   @id @default(cuid())
  name        String
  description String?
  enabled     Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  apiKeys     ApiKey[]

  @@index([enabled])
  @@map("requesters")
}

// API Key Management - Authentication tokens for requesters
model ApiKey {
  id          String    @id @default(cuid())
  keyId       String    @unique  // Public identifier (e.g., "ck_live_abc123")
  keySecret   String              // bcrypt hashed secret
  name        String              // "Production Server", "Analytics Pipeline"
  requesterId String
  requester   Requester @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  enabled     Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  createdBy   String              // Admin who created it

  @@index([requesterId])
  @@index([enabled])
  @@index([keyId])
  @@map("api_keys")
}

// Access Request History (for tracking)
model AccessRequest {
  id          String   @id @default(cuid())
  requesterId String
  startTime   BigInt
  endTime     BigInt
  purpose     String?
  metadata    Json?
  granted     Boolean
  denialReason String?
  keyCount    Int?
  createdAt   DateTime @default(now())

  @@index([requesterId])
  @@index([createdAt])
  @@index([granted])
  @@map("access_requests")
}
